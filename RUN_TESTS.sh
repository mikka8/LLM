#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
# 1. –ó–∞–ø—É—Å–∫–∞–µ—Ç Flask —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
# 2. –ñ–¥—ë—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
# 3. –ó–∞–ø—É—Å–∫–∞–µ—Ç Cypress E2E —Ç–µ—Å—Ç—ã
# 4. –ó–∞–∫—Ä—ã–≤–∞–µ—Ç Flask

set -e

echo "============================================"
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
echo "============================================"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")"

# –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python..."
pip install -q flask requests python-dotenv 2>/dev/null || true

echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Node.js..."
npm install -q 2>/dev/null || true

# –ó–∞–ø—É—Å–∫–∞–µ–º Flask —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
echo ""
echo "üîß –ó–∞–ø—É—Å–∫ Flask —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ localhost:5000..."
python src/app.py > /tmp/flask.log 2>&1 &
FLASK_PID=$!
echo "   Flask PID: $FLASK_PID"

# –ñ–¥—ë–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Flask
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Flask –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ! kill -0 $FLASK_PID 2>/dev/null; then
    echo "‚ùå Flask –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –õ–æ–≥–∏:"
    cat /tmp/flask.log
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Flask
echo "‚úì Flask —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
sleep 2

# –ó–∞–ø—É—Å–∫–∞–µ–º Cypress
echo ""
echo "üß™ –ó–∞–ø—É—Å–∫ Cypress E2E —Ç–µ—Å—Ç–æ–≤..."
npm run cypress:run:linux || CYPRESS_EXIT=$?

# –ó–∞–∫—Ä—ã–≤–∞–µ–º Flask
echo ""
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Flask —Å–µ—Ä–≤–µ—Ä–∞..."
kill $FLASK_PID 2>/dev/null || true
wait $FLASK_PID 2>/dev/null || true

echo "============================================"
echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
echo "============================================"

exit ${CYPRESS_EXIT:-0}
